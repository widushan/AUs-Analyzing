<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browser AU Detector — Rule-based</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; display:flex; gap:20px; padding:20px; }
    .panel { max-width:760px; }
    video, canvas { display:block; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    #controls { margin-bottom:10px; }
    #info { margin-top:10px; }
    .au-list { max-height:320px; overflow:auto; padding:8px; border-radius:6px; background:#f7f7f7; }
    .au-item { display:flex; justify-content:space-between; padding:4px 6px; border-bottom:1px solid #eee; }
    .au-item:last-child{border-bottom:0;}
    .good { color:green } .low { color:orange } .verylow { color:crimson }
  </style>
  <!-- Correct MediaPipe imports -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <div class="panel">
    <h2>Browser AU Detector</h2>
    <div id="controls">
      <label for="facing">user</label>
      <select id="facing">
        <option value="user">Healthy</option>
        <option value="user">Parkinson</option>
      </select>
      <button id="startBtn">Start</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <video id="video" autoplay playsinline style="width: 640px; height: 480px;"></video>
    <canvas id="overlay" width="640" height="480" style="position:relative; top:-480px; left:0;"></canvas>

    <div id="info">
      <small>Green lines show AU measurement points. Labels show AU numbers in real time.</small>
    </div>
  </div>

  <div style="width:320px">
    <h3>AU Values</h3>
    <div class="au-list" id="auList"></div>
    <div style="margin-top:10px;">
      <button id="download">Download CSV</button>
    </div>
  </div>

<script>
(async () => {
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function meanPoint(pts){ return {x: pts.reduce((s,p)=>s+p.x,0)/pts.length, y: pts.reduce((s,p)=>s+p.y,0)/pts.length}; }
  function clampNormalized(x){ if (!isFinite(x)) return 0; return Math.max(0, Math.min(1, x + 0.5)); }

  const idx = {
    leftEyeOuter: 33, rightEyeOuter: 263,
    leftUpperEyelid: 159, leftLowerEyelid: 145,
    rightUpperEyelid: 386, rightLowerEyelid: 374,
    leftInnerBrow: 70, leftOuterBrow: 105,
    rightInnerBrow: 300, rightOuterBrow: 334,
    mouthLeft: 61, mouthRight: 291,
    upperLip: 13, lowerLip: 14,
    chinLower: 152, jawPoint: 17,
    noseTip: 1, noseBridge: 6
  };

  function computeAUs(landmarks){
    const L = (i)=>({x: landmarks[i].x, y: landmarks[i].y});
    const iod = dist(L(idx.leftEyeOuter), L(idx.rightEyeOuter)) || 1;

    const au1_left = -(L(idx.leftInnerBrow).y - meanPoint([L(idx.leftUpperEyelid), L(idx.leftLowerEyelid)]).y) / iod;
    const au1_right = -(L(idx.rightInnerBrow).y - meanPoint([L(idx.rightUpperEyelid), L(idx.rightLowerEyelid)]).y) / iod;
    const au2_left = -(L(idx.leftOuterBrow).y - L(idx.leftUpperEyelid).y) / iod;
    const au2_right = -(L(idx.rightOuterBrow).y - L(idx.rightUpperEyelid).y) / iod;
    const au4_left = (L(idx.leftInnerBrow).y - L(idx.leftUpperEyelid).y) / iod;
    const au4_right = (L(idx.rightInnerBrow).y - L(idx.rightUpperEyelid).y) / iod;
    const leftGap = L(idx.leftUpperEyelid).y - L(idx.leftLowerEyelid).y;
    const rightGap = L(idx.rightUpperEyelid).y - L(idx.rightLowerEyelid).y;
    const au6_left = -leftGap / iod;
    const au6_right = -rightGap / iod;
    const au7_left = Math.max(0, au6_left * 1.2);
    const au7_right = Math.max(0, au6_right * 1.2);
    const mouthWidth = dist(L(idx.mouthLeft), L(idx.mouthRight));
    const au12_left = (L(idx.mouthRight).x - L(idx.noseTip).x) / iod;
    const au12_right = (L(idx.noseTip).x - L(idx.mouthLeft).x) / iod;
    const lipHeight = Math.abs(L(idx.upperLip).y - L(idx.lowerLip).y) || 1e-6;
    const au14_left = (mouthWidth / lipHeight) / 10;
    const au14_right = au14_left;
    const mouthMidY = (L(idx.mouthLeft).y + L(idx.mouthRight).y) / 2;
    const au15_left = (L(idx.mouthLeft).y - mouthMidY) / iod;
    const au15_right = (L(idx.mouthRight).y - mouthMidY) / iod;
    const au17_left = (L(idx.lowerLip).y - L(idx.chinLower).y) / iod;
    const au17_right = au17_left;
    const au45_left = (L(idx.leftUpperEyelid).y - L(idx.leftLowerEyelid).y) / iod;
    const au45_right = (L(idx.rightUpperEyelid).y - L(idx.rightLowerEyelid).y) / iod;

    const result = {};
    function addAU(name, left, right){
      const avg = (left + right) / 2;
      const asym = Math.abs(left - right);
      result[name] = clampNormalized(avg);
      result[name + '_asym'] = clampNormalized(asym);
    }

    addAU('AU1', au1_left, au1_right);
    addAU('AU2', au2_left, au2_right);
    addAU('AU4', au4_left, au4_right);
    addAU('AU6', au6_left, au6_right);
    addAU('AU7', au7_left, au7_right);
    addAU('AU12', au12_left, au12_right);
    addAU('AU14', au14_left, au14_right);
    addAU('AU15', au15_left, au15_right);
    addAU('AU17', au17_left, au17_right);
    addAU('AU45', au45_left, au45_right);

    result['asymmetry_total'] = clampNormalized(
      result['AU1_asym'] + result['AU2_asym'] + result['AU4_asym'] +
      result['AU6_asym'] + result['AU7_asym'] + result['AU12_asym'] +
      result['AU14_asym'] + result['AU15_asym'] + result['AU17_asym'] +
      result['AU45_asym']
    );

    result['iod'] = iod;
    return result;
  }

  const video = document.getElementById('video');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const auListDiv = document.getElementById('auList');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const facing = document.getElementById('facing');
  const downloadBtn = document.getElementById('download');

  let camera = null, faceMesh = null, lastAUs = null, csvRows = [], samplingInterval = null;

  faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });
  faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5 });
  faceMesh.onResults(onResults);

  function drawLine(i, j, landmarks, label) {
    ctx.beginPath();
    ctx.moveTo(landmarks[i].x * overlay.width, landmarks[i].y * overlay.height);
    ctx.lineTo(landmarks[j].x * overlay.width, landmarks[j].y * overlay.height);
    ctx.strokeStyle = "lime";
    ctx.lineWidth = 2;
    ctx.stroke();
    const midX = (landmarks[i].x + landmarks[j].x) / 2 * overlay.width;
    const midY = (landmarks[i].y + landmarks[j].y) / 2 * overlay.height;
    ctx.fillStyle = "black";
    ctx.font = "14px Arial";
    ctx.fillText(label, midX + 4, midY - 4);
  }

  function onResults(results){
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    ctx.clearRect(0,0,overlay.width, overlay.height);

    if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
      ctx.fillStyle = "orange";
      ctx.fillText("No face detected", 10, 20);
      return;
    }
    const lm = results.multiFaceLandmarks[0];
    lastAUs = computeAUs(lm);

    // Simple 1–2 lines per AU
    
    // AU1
    drawLine(idx.leftInnerBrow, idx.leftUpperEyelid, lm, "AU1(L)");
    drawLine(idx.rightInnerBrow, idx.rightUpperEyelid, lm, "AU1(R)");
    // AU2
    drawLine(idx.leftOuterBrow, idx.leftUpperEyelid, lm, "AU2(L)");
    drawLine(idx.rightOuterBrow, idx.rightUpperEyelid, lm, "AU2(R)");
    // AU4
    drawLine(idx.leftInnerBrow, idx.leftLowerEyelid, lm, "AU4(L)");
    drawLine(idx.rightInnerBrow, idx.rightLowerEyelid, lm, "AU4(R)");
    // AU6
    drawLine(idx.leftUpperEyelid, idx.leftLowerEyelid, lm, "AU6(L)");
    drawLine(idx.rightUpperEyelid, idx.rightLowerEyelid, lm, "AU6(R)");
    // AU7
    drawLine(idx.leftLowerEyelid, idx.leftUpperEyelid, lm, "AU7(L)");
    drawLine(idx.rightLowerEyelid, idx.rightUpperEyelid, lm, "AU7(R)");
    // AU9 and AU10 (center features)
    drawLine(idx.noseBridge, idx.upperLip, lm, "AU9");
    drawLine(idx.noseTip, idx.upperLip, lm, "AU10");
    // AU12
    drawLine(idx.mouthLeft, idx.noseTip, lm, "AU12(L)");
    drawLine(idx.mouthRight, idx.noseTip, lm, "AU12(R)");
    // AU14
    drawLine(idx.mouthLeft, idx.upperLip, lm, "AU14(L)");
    drawLine(idx.mouthRight, idx.upperLip, lm, "AU14(R)");
    // AU15
    drawLine(idx.mouthLeft, idx.lowerLip, lm, "AU15(L)");
    drawLine(idx.mouthRight, idx.lowerLip, lm, "AU15(R)");
    // AU17
    drawLine(idx.lowerLip, idx.chinLower, lm, "AU17");
    // AU20
    drawLine(idx.mouthLeft, idx.mouthRight, lm, "AU20");
    // AU23 and AU25
    drawLine(idx.upperLip, idx.lowerLip, lm, "AU23/AU25");
    // AU26
    drawLine(idx.jawPoint, idx.chinLower, lm, "AU26");
    // AU45
    drawLine(idx.leftUpperEyelid, idx.leftLowerEyelid, lm, "AU45(L)");
    drawLine(idx.rightUpperEyelid, idx.rightLowerEyelid, lm, "AU45(R)");
    

    renderAUList(lastAUs);
  }

  function renderAUList(aus){
    const order = ['AU1','AU2','AU4','AU6','AU7','AU9','AU10','AU12','AU14','AU15','AU17','AU20','AU23','AU25','AU26','AU45'];
    auListDiv.innerHTML = '';
    order.forEach(k=>{
      const val = aus[k]||0;
      const item = document.createElement('div');
      item.className = 'au-item';
      const name = document.createElement('div'); name.textContent = k;
      const v = document.createElement('div'); v.textContent = val.toFixed(2);
      if (val > 0.6) v.className = 'good';
      else if (val > 0.3) v.className = 'low';
      else v.className = 'verylow';
      item.appendChild(name); item.appendChild(v);
      auListDiv.appendChild(item);
    });
  }

  startBtn.onclick = async () => {
    startBtn.disabled = true; stopBtn.disabled = false;
    const constraints = { video: { width: 640, height: 480, facingMode: facing.value } };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    camera = new Camera(video, { onFrame: async () => { await faceMesh.send({image: video}); }, width: 640, height: 480 });
    camera.start();
    csvRows = [['timestamp,AU1,AU1_asym,AU2,AU2_asym,AU4,AU4_asym,AU6,AU6_asym,AU7,AU7_asym,AU12,AU12_asym,AU14,AU14_asym,AU15,AU15_asym,AU17,AU17_asym,AU45,AU45_asym,asymmetry_total'].join(',')];
    samplingInterval = setInterval(()=> {
      if (lastAUs){
        csvRows.push([new Date().toISOString(), ...Object.values(lastAUs).map(v=>v.toFixed(3))].join(','));
      }
    }, 500);
  };

  stopBtn.onclick = () => {
    startBtn.disabled = false; stopBtn.disabled = true;
    if (camera) camera.stop();
    if (video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject = null; }
    clearInterval(samplingInterval);
  };

  downloadBtn.onclick = () => {
    if (csvRows.length <= 1) return alert('No AU samples yet.');
    const blob = new Blob([csvRows.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'aus_samples.csv'; a.click();
    URL.revokeObjectURL(url);
  };
})();
</script>
</body>
</html>
